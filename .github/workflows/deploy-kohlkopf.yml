name: Deploy Kohlkopf App

on:
  push:
    branches:
      - main
    paths:
      - 'apps/kohlkopf/**'
      - 'packages/myframework-core/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create deployment package
        run: |
          cd apps/kohlkopf
          tar -czf ../../kohlkopf-deploy.tar.gz \
            --exclude='legacy/*' \
            --exclude='var/cache/*' \
            --exclude='var/log/*' \
            --exclude='vendor/*' \
            --exclude='.env.local' \
            --exclude='.git' \
            .
      
      - name: Deploy to server
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
          
          # Upload package
          scp -i ~/.ssh/deploy_key kohlkopf-deploy.tar.gz ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/
          
          # Execute deployment
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} 'bash -s' << 'ENDSSH'
            set -e
            
            DEPLOY_PATH="/var/www/kohlkopf"
            BACKUP_PATH="$HOME/kohlkopf-backups/$(date +%Y%m%d_%H%M%S)"
            
            # Backup current state
            if [ -d "$DEPLOY_PATH/vendor" ]; then
              echo "Creating backup..."
              mkdir -p $(dirname $BACKUP_PATH)
              cp -r $DEPLOY_PATH $BACKUP_PATH
            fi
            
            # Extract new version
            echo "Extracting new version..."
            mkdir -p $DEPLOY_PATH
            tar -xzf /tmp/kohlkopf-deploy.tar.gz -C $DEPLOY_PATH
            rm /tmp/kohlkopf-deploy.tar.gz
            
            # Deploy
            cd $DEPLOY_PATH
            
            echo "Preparing for deployment..."
            rm -f composer.lock
            composer config --unset repositories.0 || true
            
            echo "Installing dependencies..."
            SYMFONY_DEPRECATIONS_HELPER=disabled composer install --no-dev --optimize-autoloader --no-scripts
            
            echo "Setting permissions..."
            chmod -R 775 var/ 2>/dev/null || true
            
            echo "Clearing cache..."
            APP_ENV=prod php bin/console cache:clear --no-warmup
            APP_ENV=prod php bin/console cache:warmup
            
            echo "Compiling assets..."
            APP_ENV=prod php bin/console importmap:install
            APP_ENV=prod php bin/console asset-map:compile
            
            # Reload PHP-FPM
            if command -v systemctl &> /dev/null; then
              echo "Reloading PHP-FPM..."
              systemctl reload php8.4-fpm 2>/dev/null || true
            fi
            
            echo "✅ Deployment successful!"
            echo "Backup: $BACKUP_PATH"
          ENDSSH
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi

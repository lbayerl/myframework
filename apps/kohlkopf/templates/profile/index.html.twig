{% extends 'base.html.twig' %}

{% block title %}Mein Profil - Kohlkopf{% endblock %}

{% block page_title %}Mein Profil{% endblock %}

{% block page_subtitle %}Pers√∂nliche Einstellungen und Benachrichtigungen{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        {# User Info Card #}
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-person-circle"></i> Benutzerinformationen</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px; font-size: 2rem;">
                            {{ app.user.displayName|first|upper }}
                        </div>
                    </div>

                    {{ form_start(profileForm) }}
                        {{ form_row(profileForm.displayName) }}
                        <button type="submit" class="btn btn-primary w-100 mb-3">
                            <i class="bi bi-save"></i> Speichern
                        </button>
                    {{ form_end(profileForm) }}

                    <div class="mb-3">
                        <label class="form-label text-muted small mb-0">E-Mail-Adresse</label>
                        <div class="fw-semibold">{{ app.user.email }}</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small mb-0">E-Mail verifiziert</label>
                        <div>
                            {% if app.user.verified %}
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> Verifiziert</span>
                            {% else %}
                                <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle"></i> Nicht verifiziert</span>
                            {% endif %}
                        </div>
                    </div>

                    <div>
                        <label class="form-label text-muted small mb-0">Rollen</label>
                        <div>
                            {% for role in app.user.roles %}
                                <span class="badge bg-secondary">{{ role }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Push Notifications Card #}
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-bell"></i> Push-Benachrichtigungen</h5>
                </div>
                <div class="card-body">
                    <div id="notification-status" class="alert d-none mb-3" role="alert"></div>

                    <div id="not-supported" class="alert alert-warning d-none">
                        <strong><i class="bi bi-x-circle"></i> Nicht unterst√ºtzt:</strong>
                        <span id="not-supported-reason">Dein Browser unterst√ºtzt keine Push-Benachrichtigungen.</span>
                    </div>

                    <div id="permission-denied" class="alert alert-danger d-none">
                        <strong><i class="bi bi-shield-x"></i> Berechtigung verweigert:</strong> Du hast Benachrichtigungen blockiert. Bitte aktiviere sie in deinen Browser-Einstellungen.
                    </div>

                    <div id="controls" class="d-none">
                        <p class="text-muted">
                            Bleibe auf dem Laufenden mit sofortigen Benachrichtigungen √ºber Konzerte und wichtige Updates.
                        </p>

                        <div class="d-grid gap-2">
                            <button id="subscribe-btn" class="btn btn-primary btn-lg d-none">
                                <i class="bi bi-bell"></i> Benachrichtigungen f√ºr dieses Ger√§t aktivieren
                            </button>

                            <button id="unsubscribe-btn" class="btn btn-outline-secondary btn-lg d-none">
                                <i class="bi bi-bell-slash"></i> Benachrichtigungen f√ºr dieses Ger√§t deaktivieren
                            </button>

                            <button id="test-btn" class="btn btn-success d-none">
                                <i class="bi bi-send"></i> Test-Benachrichtigung senden
                            </button>
                        </div>

                        <hr class="my-4">

                        <h6 class="mb-3"><i class="bi bi-phone"></i> Registrierte Ger√§te</h6>
                        <div id="subscriptions-empty" class="text-muted small d-none">
                            Keine gespeicherten Push-Subscriptions gefunden.
                        </div>
                        <div id="subscriptions-list" class="list-group"></div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-info-circle"></i> So funktioniert es</h5>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2">Klicke auf "Benachrichtigungen f√ºr dieses Ger√§t aktivieren"</li>
                        <li class="mb-2">Erlaube Benachrichtigungen, wenn dein Browser fragt</li>
                        <li class="mb-2">Nutze "Test-Benachrichtigung senden", um zu pr√ºfen, ob es funktioniert</li>
                        <li>Du erh√§ltst Benachrichtigungen auch dann, wenn die App geschlossen ist</li>
                    </ol>
                </div>
            </div>

            <div class="card mt-4 bg-light">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-shield-check"></i> Datenschutz</h6>
                    <p class="small text-muted mb-0">
                        Push-Benachrichtigungen erm√∂glichen es dir, sofort Updates zu erhalten - auch wenn du die App gerade nicht nutzt.
                        Du kannst Benachrichtigungen pro Ger√§t jederzeit deaktivieren. Das Abonnement gilt immer nur f√ºr dieses Ger√§t.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
const VAPID_PUBLIC_KEY = '{{ my_framework_core_push_vapid_public_key() }}';

const statusDiv = document.getElementById('notification-status');
const notSupportedDiv = document.getElementById('not-supported');
const permissionDeniedDiv = document.getElementById('permission-denied');
const controlsDiv = document.getElementById('controls');
const subscribeBtn = document.getElementById('subscribe-btn');
const unsubscribeBtn = document.getElementById('unsubscribe-btn');
const testBtn = document.getElementById('test-btn');
const subscriptionsList = document.getElementById('subscriptions-list');
const subscriptionsEmpty = document.getElementById('subscriptions-empty');

// Utility: Convert VAPID key to Uint8Array
function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

// Show status message
function showStatus(message, type = 'info') {
    statusDiv.textContent = message;
    statusDiv.className = `alert alert-${type}`;
    statusDiv.classList.remove('d-none');
    setTimeout(() => statusDiv.classList.add('d-none'), 5000);
}

function escapeHtml(value) {
    return value
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
}

function formatDate(isoString) {
    try {
        return new Date(isoString).toLocaleString('de-DE');
    } catch {
        return isoString;
    }
}

function detectDeviceLabel() {
    const ua = navigator.userAgent;

    let browser = 'Browser';
    if (ua.includes('Firefox')) {
        browser = 'Firefox';
    } else if (ua.includes('Edg/')) {
        browser = 'Edge';
    } else if (ua.includes('OPR/') || ua.includes('Opera')) {
        browser = 'Opera';
    } else if (ua.includes('Chrome')) {
        browser = 'Chrome';
    } else if (ua.includes('Safari')) {
        browser = 'Safari';
    }

    let platform = 'Desktop';
    if (/Android/i.test(ua)) {
        platform = 'Android';
    } else if (/iPhone|iPad|iPod/i.test(ua)) {
        platform = 'iOS';
    }

    return `${browser} ${platform}`;
}

function renderSubscriptions(subscriptions, currentEndpoint = null) {
    subscriptionsList.innerHTML = '';

    if (!subscriptions || subscriptions.length === 0) {
        subscriptionsEmpty.classList.remove('d-none');
        return;
    }

    subscriptionsEmpty.classList.add('d-none');

    for (const item of subscriptions) {
        const isCurrentDevice = currentEndpoint !== null && item.endpoint === currentEndpoint;
        const row = document.createElement('div');
        row.className = 'list-group-item d-flex justify-content-between align-items-start gap-3';
        row.innerHTML = `
            <div class="flex-grow-1">
                <div class="fw-semibold">${escapeHtml(item.deviceLabel || 'Unbekanntes Ger√§t')}</div>
                <div class="fw-semibold small mb-1">${escapeHtml(item.endpointPreview)}</div>
                <div class="text-muted small">Registriert: ${escapeHtml(formatDate(item.createdAt))}</div>
                ${isCurrentDevice ? '<span class="badge bg-success mt-2">Dieses Ger√§t</span>' : ''}
            </div>
            <button class="btn btn-sm btn-outline-danger" data-subscription-id="${item.id}" type="button">
                <i class="bi bi-trash"></i> Entfernen
            </button>
        `;

        subscriptionsList.appendChild(row);
    }
}

async function loadSubscriptions() {
    try {
        const listResponse = await fetch('{{ path('myframework_notifications_subscriptions') }}');
        if (!listResponse.ok) {
            throw new Error(`HTTP ${listResponse.status}`);
        }

        const listResult = await listResponse.json();
        const subscriptions = listResult.subscriptions ?? [];

        let currentEndpoint = null;
        try {
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.getSubscription();
            currentEndpoint = subscription?.endpoint ?? null;
        } catch {
            currentEndpoint = null;
        }

        renderSubscriptions(subscriptions, currentEndpoint);
    } catch (error) {
        console.error('Loading subscriptions failed:', error);
        subscriptionsList.innerHTML = '';
        subscriptionsEmpty.classList.remove('d-none');
        subscriptionsEmpty.textContent = 'Subscriptions konnten nicht geladen werden.';
    }
}

async function removeSubscription(subscriptionId) {
    const deleteUrlTemplate = '{{ path('myframework_notifications_subscriptions_delete', {'id': 0}) }}';
    const deleteUrl = deleteUrlTemplate.replace(/0$/, String(subscriptionId));

    const response = await fetch(deleteUrl, {
        method: 'DELETE'
    });

    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `HTTP ${response.status}`);
    }
}

// Check if push notifications are supported
async function checkSupport() {
    const notSupportedReason = document.getElementById('not-supported-reason');

    // Check HTTPS (required except localhost)
    const isSecure = window.location.protocol === 'https:' ||
                     window.location.hostname === 'localhost' ||
                     window.location.hostname === '127.0.0.1';

    if (!isSecure) {
        notSupportedReason.textContent = 'Push-Benachrichtigungen ben√∂tigen eine sichere HTTPS-Verbindung.';
        notSupportedDiv.classList.remove('d-none');
        return false;
    }

    if (!('serviceWorker' in navigator)) {
        notSupportedReason.textContent = 'Dein Browser unterst√ºtzt keine Service Worker.';
        notSupportedDiv.classList.remove('d-none');
        return false;
    }

    if (!('PushManager' in window)) {
        notSupportedReason.textContent = 'Dein Browser unterst√ºtzt keine Push-Benachrichtigungen.';
        notSupportedDiv.classList.remove('d-none');
        return false;
    }

    return true;
}

// Get current subscription status
async function updateUI() {
    try {
        // Wait for service worker with timeout
        const registration = await Promise.race([
            navigator.serviceWorker.ready,
            new Promise((_, reject) => setTimeout(() => reject(new Error('Service Worker timeout')), 5000))
        ]);

        const subscription = await registration.pushManager.getSubscription();

        if (subscription) {
            subscribeBtn.classList.add('d-none');
            unsubscribeBtn.classList.remove('d-none');
            testBtn.classList.remove('d-none');
        } else {
            subscribeBtn.classList.remove('d-none');
            unsubscribeBtn.classList.add('d-none');
            testBtn.classList.add('d-none');
        }
    } catch (error) {
        console.error('updateUI failed:', error);
        const notSupportedReason = document.getElementById('not-supported-reason');
        notSupportedReason.textContent = 'Service Worker konnte nicht geladen werden. Bitte lade die Seite neu.';
        notSupportedDiv.classList.remove('d-none');
        controlsDiv.classList.add('d-none');
    }
}

// Subscribe to push notifications
async function subscribe() {
    try {
        const registration = await navigator.serviceWorker.ready;

        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });

        const subscriptionJson = subscription.toJSON();

        const missingFields = [];
        if (!subscriptionJson.endpoint) missingFields.push('endpoint');
        if (!subscriptionJson.keys?.auth) missingFields.push('keys.auth');
        if (!subscriptionJson.keys?.p256dh) missingFields.push('keys.p256dh');

        if (missingFields.length > 0) {
            throw new Error(`Ung√ºltige Subscription-Daten: ${missingFields.join(', ')}`);
        }

        const subscriptionData = {
            endpoint: subscriptionJson.endpoint,
            keys: {
                auth: subscriptionJson.keys.auth,
                p256dh: subscriptionJson.keys.p256dh
            },
            deviceLabel: detectDeviceLabel(),
        };

        // Send subscription to server
        const response = await fetch('{{ path('myframework_notifications_subscribe') }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(subscriptionData)
        });

        if (response.ok) {
            showStatus('‚úÖ Benachrichtigungen f√ºr dieses Ger√§t erfolgreich aktiviert!', 'success');
            await updateUI();
            await loadSubscriptions();
        } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || 'Speichern des Abonnements fehlgeschlagen');
        }
    } catch (error) {
        console.error('Subscription failed:', error);
        if (Notification.permission === 'denied') {
            permissionDeniedDiv.classList.remove('d-none');
        } else {
            showStatus('‚ùå Aktivierung fehlgeschlagen: ' + error.message, 'danger');
        }
    }
}

// Unsubscribe from push notifications
async function unsubscribe() {
    try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();

        if (subscription) {
            // Remove from server
            const response = await fetch('{{ path('myframework_notifications_unsubscribe') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ endpoint: subscription.endpoint })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || 'Server konnte Subscription nicht entfernen');
            }

            await subscription.unsubscribe();
        }

        showStatus('Benachrichtigungen f√ºr dieses Ger√§t deaktiviert', 'info');
        await updateUI();
        await loadSubscriptions();
    } catch (error) {
        console.error('Unsubscribe failed:', error);
        showStatus('‚ùå Deaktivierung fehlgeschlagen', 'danger');
    }
}

// Send test notification
async function sendTest() {
    try {
        testBtn.disabled = true;
        testBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Wird gesendet...';

        const response = await fetch('{{ path('myframework_notifications_test') }}', {
            method: 'POST'
        });

        const contentType = response.headers.get('content-type') || '';

        if (!response.ok) {
            const bodyText = await response.text().catch(() => '');
            console.error('Test request failed:', response.status, bodyText);
            throw new Error(`Server-Fehler: ${response.status}`);
        }

        if (!contentType.includes('application/json')) {
            const bodyText = await response.text().catch(() => '');
            console.error('Unexpected non-JSON test response:', bodyText);
            throw new Error('Unerwartete Server-Antwort (kein JSON)');
        }

        const result = await response.json();

        if (result.success) {
            showStatus(`‚úÖ Test-Benachrichtigung gesendet! (${result.sent} gesendet, ${result.failed} fehlgeschlagen)`, 'success');
        } else {
            showStatus('‚ùå Senden der Test-Benachrichtigung fehlgeschlagen', 'danger');
        }
    } catch (error) {
        console.error('Test failed:', error);
        showStatus('‚ùå Fehler beim Senden der Test-Benachrichtigung', 'danger');
    } finally {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="bi bi-send"></i> Test-Benachrichtigung senden';
    }
}

// Initialize
(async () => {
    console.log('üîî Push notification init started');
    console.log('üì± Browser info:', {
        userAgent: navigator.userAgent,
        https: window.location.protocol === 'https:',
        serviceWorker: 'serviceWorker' in navigator,
        pushManager: 'PushManager' in window
    });

    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.getRegistration('/');
            if (registration) {
                await registration.update();
                if (registration.waiting) {
                    registration.waiting.postMessage({ type: 'skip-waiting' });
                }
            }
        } catch (error) {
            console.warn('Service worker update skipped:', error);
        }
    }

    if (!(await checkSupport())) {
        console.log('‚ùå Support check failed');
        return;
    }

    console.log('‚úÖ Support check passed');
    controlsDiv.classList.remove('d-none');
    await updateUI();
    await loadSubscriptions();

    subscriptionsList.addEventListener('click', async (event) => {
        const button = event.target.closest('button[data-subscription-id]');
        if (!button) {
            return;
        }

        const subscriptionId = Number(button.dataset.subscriptionId);
        if (!Number.isInteger(subscriptionId)) {
            return;
        }

        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
            await removeSubscription(subscriptionId);
            showStatus('Subscription entfernt.', 'info');
            await updateUI();
            await loadSubscriptions();
        } catch (error) {
            console.error('Removing subscription failed:', error);
            showStatus('‚ùå Entfernen fehlgeschlagen: ' + error.message, 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    });

    subscribeBtn.addEventListener('click', subscribe);
    unsubscribeBtn.addEventListener('click', unsubscribe);
    testBtn.addEventListener('click', sendTest);

    console.log('üîî Push notification init completed');
})();
</script>
{% endblock %}
